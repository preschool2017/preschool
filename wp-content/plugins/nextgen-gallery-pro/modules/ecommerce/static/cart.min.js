!function(t){Ngg_Pro_Cart={get_ajax_url:function(){return"undefined"!=typeof photocrati_ajax?photocrati_ajax.url:"undefined"!=typeof parent.photocrati_ajax?parent.photocrati_ajax.url:null},Models:{},Views:{}},Ngg_Pro_Cart.Models.Image=Backbone.Model.extend({idAttribute:"pid",subtotal:function(){var t=0;return this.get("items").each(function(e){t+=e.subtotal()}),t}}),Ngg_Pro_Cart.Models.PricelistItem=Backbone.Model.extend({idAttribute:"ID",defaults:{quantity:0},subtotal:function(){return parseFloat(this.get("price"))*parseInt(this.get("quantity"))}}),Ngg_Pro_Cart.Models.ImageCollection=Backbone.Collection.extend({model:Ngg_Pro_Cart.Models.Image,subtotal:function(){var t=0;return this.each(function(e){t+=e.subtotal()}),t}}),Ngg_Pro_Cart.Models.PricelistItemCollection=Backbone.Collection.extend({model:Ngg_Pro_Cart.Models.PricelistItem}),Ngg_Pro_Cart.Models.Cart=Ngg_Pro_Cart.Models.ImageCollection.extend({shipping:0,total:0,sub_total:0,tax:0,use_home_country:!0,allow_international_shipping:!1,coupon:"",empty_cart:function(){this.reset(),this.save()},refresh_from_server:function(){var e=this,i={action:"get_cart_items",cart:e.to_json(),use_home_country:this.use_home_country};t.post(Ngg_Pro_Cart.get_ajax_url(),i,function(t){"object"!=typeof t&&(t=JSON.parse(t)),e.shipping=t.shipping,e.sub_total=t.subtotal,e.total=t.total,e.tax=t.tax,e.has_shippable_items=t.has_shippable_items,e.trigger("change:quantity"),e.trigger("refreshed_from_server",!1,t)})},get_storage:function(){if("true"==Ngg_Pro_Cart_Settings.use_cookies)return Ngg_Store;var t={namespace:"nextgen-gallery-cart",storages:["local","cookie"],storage:"local",expiresDays:10,secure:!1},e=new window.Basil(t);return{get:function(t){return e.get(t)},set:function(t,i){return e.set(t,i)},del:function(t){return e.remove(t),!this.has(t)},has:function(t){var e=this.get(t);return"undefined"!=typeof e&&null!=e},save:function(){return!0}}},initialize:function(){this.ready=!1,this.storage=this.get_storage();var e=this.storage.get("ngg_pro_cart");if("undefined"!=typeof e&&null!=e){"object"!=typeof e&&(e=JSON.parse(e));var i=this;t.post(Ngg_Pro_Cart.get_ajax_url(),{action:"get_cart_items",cart:e},function(t){"object"!=typeof t&&(t=JSON.parse(t)),i.has_shippable_items=t.has_shippable_items,i.allow_international_shipping=t.allow_international_shipping,i.shipping=t.shipping,i.sub_total=t.subtotal,i.total=t.total,i.tax=t.tax,"undefined"!=typeof t.coupon&&(i.coupon=t.coupon.code);for(var e=0;e<t.image_ids.length;e++){for(var n=parseInt(t.image_ids[e]),a=t.images[n],r=new Ngg_Pro_Cart.Models.PricelistItemCollection,o=0;o<a.item_ids.length;o++){var _=parseInt(a.item_ids[o]);if(_>0){var s=a.items[_];s.id=_,s.image_id=n,r.add(s)}}a.id=n,a.items=r,delete a.item_ids,i.add(a)}i.ready=!0,i.trigger("ready"),i.trigger("refreshed_from_server",!0,t)})}else this.ready=!0,this.emit_ready()},emit_ready:function(){var t=this;setTimeout(function(){t.trigger("ready")},0)},save:function(){this.storage.set("ngg_pro_cart",this.to_json())},to_json:function(){var t={image_ids:[],images:{},coupon:this.coupon};return this.each(function(e){t.image_ids.push(e.id);var i={item_ids:[],items:{}};e.get("items").each(function(t){i.item_ids.push(t.id),i.items[t.id]={quantity:t.get("quantity")}}),t.images[e.id]=i}),t},update_quantity:function(t,e){var i=!(parseInt(e.get("quantity"))>0),n=this.get(t);if(n||i||(n=new Ngg_Pro_Cart.Models.Image({pid:t,items:new Ngg_Pro_Cart.Models.PricelistItemCollection}),this.add(n)),n){var a=n.get("items"),r=a.get(e.id);r?i?a.remove(r):r.set(e.attributes):i||a.add(e.attributes),0==a.length&&this.remove(n)}this.refresh_from_server(),this.save()},item_count:function(){var t=0;return this.each(function(e){t+=e.get("items").length}),t}}),Ngg_Pro_Cart.get_instance=function(){return"undefined"==typeof Ngg_Pro_Cart.instance&&(Ngg_Pro_Cart.instance=new Ngg_Pro_Cart.Models.Cart),Ngg_Pro_Cart.instance},Ngg_Pro_Cart.Views.TemplateView=Backbone.View.extend({render_template:function(e){var i=t("#"+this.template).html();for(var n in this.model.attributes)if("string"==typeof n)for(var a=this.model.get(n),r="{"+this.object_name+"."+n+"}";i.indexOf(r)>=0;)i=i.replace(r,a);if("undefined"!=typeof e)for(var n in e)for(var r="{"+n+"}";i.indexOf(r)>=0;)i=i.replace(r,e[n]);this.$el.html(i)}}),Ngg_Pro_Cart.Views.Item_Row=Ngg_Pro_Cart.Views.TemplateView.extend({tagName:"tr",className:"ngg_pro_cart_image_item",template:"ngg_pro_cart_item_tmpl",object_name:"item",initialize:function(t){this.image_id=t.image_id,this.model.on("change:quantity",this.update_subtotal,this)},quantity_changed:function(e){var i=t(e).val();i.length>0&&(i=parseInt(i),this.model.set("quantity",parseInt(i)),Ngg_Pro_Cart.get_instance().update_quantity(this.image_id,this.model))},update_subtotal:function(){this.$el.find(".subtotal_column span").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.subtotal()))},render:function(){var e=this;this.render_template({"image.filename":Ngg_Pro_Cart.get_instance().get(this.image_id).get("filename")}),this.$el.find(".price_column").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.get("price"))),this.update_subtotal();var i=this.$el.find(".ngg_pro_delete_item");return i.on("click",function(i){i.preventDefault(),e.collection.remove(e.model.id),e.model.set("quantity",0),Ngg_Pro_Cart.get_instance().update_quantity(e.image_id,e.model),e.$el.fadeOut(400,function(){t(this).remove()})}),this.$el.find(".nggpl-quantity_field").on("change",function(){e.quantity_changed(this)}),this.el}}),Ngg_Pro_Cart.Views.Image_Row=Ngg_Pro_Cart.Views.TemplateView.extend({tagName:"tr",className:"ngg_pro_cart_image",template:"ngg_pro_cart_image_tmpl",object_name:"image",initialize:function(){this.model.get("items").on("remove",this.item_removed,this)},item_removed:function(t){0==this.model.get("items").length&&this.$el.fadeOut().remove()},render:function(){this.render_template();var t=this.$el.find(".ngg_pro_cart_items"),e=this.model.get("items");return e.each(function(i){var n=new Ngg_Pro_Cart.Views.Item_Row({model:i,collection:e,image_id:this.model.id});t.append(n.render())},this),this.el}}),Ngg_Pro_Cart.Views.Coupon_Row=Backbone.View.extend({el:"#ngg_pro_cart_coupon_tr",code:"",events:{"click #ngg_pro_cart_coupon_apply":"handle_apply_click","keyup #ngg_pro_cart_coupon_field":"handle_apply_key"},initialize:function(){this.model=Ngg_Pro_Cart.get_instance(),this.model.on("refreshed_from_server",this.handle_server_update,this)},handle_server_update:function(e,i){var n=Ngg_Pro_Cart.get_instance(),a=t("#ngg_pro_cart_coupon_errors"),r=t("#ngg_pro_cart_coupon_undiscounted_subtotal_tr, #ngg_pro_cart_coupon_discount_amount_tr");"undefined"!=typeof i.coupon?(n.coupon=i.coupon.code,a.hide(),t("#ngg_pro_cart_coupon_hidden_field").val(i.coupon.code),t("#nggpl-undiscounced_subtotal_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,parseFloat(i.undiscounted_subtotal))),t("#nggpl-discount_amount_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,parseFloat(i.coupon.discount_given))),t("#ngg_pro_cart_coupon_field").blur(),r.show()):e||"undefined"==n.coupon||""==n.coupon||(n.coupon="",r.hide(),a.text("Invalid coupon"),a.fadeIn().delay(1e3).fadeOut(500),t("#ngg_pro_cart_coupon_field").focus())},handle_apply_click:function(t){t.preventDefault(),this.apply()},handle_apply_key:function(t){13==t.keyCode&&t.preventDefault()},apply:function(){var e=Ngg_Pro_Cart.get_instance(),i=t("#ngg_pro_cart_coupon_field");e.coupon=i.val(),this.code=e.coupon,i.val(""),e.refresh_from_server(),e.save()}}),Ngg_Pro_Cart.Views.Cart=Backbone.View.extend({el:"#ngg_pro_checkout",initialize:function(){this.model=Ngg_Pro_Cart.get_instance(),this.model.on("ready",this.render,this),this.model.on("change:quantity",this.update_totals,this),this.model.ready&&this.render()},events:{"keypress .nggpl-quantity_field":"sanitize_quantity"},get_cart_images_el:function(){var e=this.$el.find(".ngg_pro_cart_images");return 0==e.length&&(e=t(".ngg_pro_cart_images").parent().detach(),this.$el.append(e),e=this.$el.find(".ngg_pro_cart_images")),e},fix_ie_dom:function(){if(0==this.$el.find("#ngg_pro_links_wrapper").length){var e=t("#ngg_pro_links_wrapper").detach();this.$el.prepend(e)}if(0==this.$el.find("#ngg_pro_checkout_buttons").length){var i=t("#ngg_pro_checkout_buttons").detach();this.$el.append(i)}},sanitize_quantity:function(t){return 8==t.keyCode||37==t.keyCode||39==t.keyCode||9==t.keyCode||46==t.keyCode||t.charCode>=48&&t.charCode<=57||(t.preventDefault(),!1)},update_totals:function(e){"undefined"==typeof e&&(e=!1);var i=this.get_cart_images_el(),n=t("#ngg_pro_no_items"),a=t("#ngg_pro_checkout_buttons");this.model.length>0?e?(i.show(),n.hide(),a.show()):(i.fadeIn("fast"),n.fadeOut("fast"),a.fadeIn("fast")):e?(i.hide(),a.hide(),n.show()):(i.fadeOut("fast"),a.fadeOut("fast"),n.fadeIn("fast")),t("#ngg_pro_checkout").toggleClass("ngg_cart_shippable_items",this.model.has_shippable_items).toggleClass("ngg_cart_free",0==parseFloat(this.model.total)),this.$el.find("#nggpl-subtotal_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,parseFloat(this.model.sub_total))),this.$el.find("#nggpl-shipping_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,parseFloat(this.model.shipping))),this.$el.find("#nggpl-total_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,parseFloat(this.model.total))),this.$el.find("#nggpl-tax_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,parseFloat(this.model.tax)))},render:function(){var e=this;this.model.allow_international_shipping?(t("#ship_to_row").show(),t("#nggpl-ship_to_field select").change(function(){t("#nggpl-shipping_field").text("Calculating..."),e.model.use_home_country=t(this).val(),e.model.refresh_from_server()})):t("#ship_to_row").hide(),this.model.each(function(t){var i=e.get_cart_images_el(),n=new Ngg_Pro_Cart.Views.Image_Row({model:t});i.append(n.render())}),new Ngg_Pro_Cart.Views.Coupon_Row,this.update_totals(!0),this.fix_ie_dom(),this.$el.css("visibility","visible")}}),Ngg_Pro_Cart.Views.Add_To_Cart=Backbone.View.extend({tagName:"div",id:"ngg_add_to_cart_container",className:"scrollable",events:function(){return{"touchstart #ngg_checkout_btn":"redirect_to_checkout","click #ngg_checkout_btn":"redirect_to_checkout","touchstart .nggpl-cart_count":"redirect_to_checkout","click .nggpl-cart_count":"redirect_to_checkout","keypress .nggpl-quantity_field":"sanitize_quantity","blur .nggpl-quantity_field":"quantity_lost_focus","focusout .nggpl-quantity_field":"quantity_lost_focus","touchstart #ngg_update_cart_btn":"update_cart","click #ngg_update_cart_btn":"update_cart"}},quantity_lost_focus:function(e){e.stopPropagation(),e.preventDefault(),t(window).trigger("resize"),t(".galleria-sidebar-container").focus()},update_cart:function(e){e.stopPropagation(),e.preventDefault(),t("#nggpl-items_for_sale td.nggpl-quantity_field input").each(function(){t(this).trigger("updated_quantity")}),this.update_cart_summary(!0)},sanitize_quantity:function(t){return t.stopPropagation(),8==t.keyCode||37==t.keyCode||39==t.keyCode||9==t.keyCode||46==t.keyCode||t.charCode>=48&&t.charCode<=57||(t.preventDefault(),!1)},initialize:function(t){this.image_id=t.image_id,this.container=t.container,Ngg_Pro_Cart.get_instance().on("ready",this.emit_ready,this),Ngg_Pro_Cart.get_instance().ready&&this.emit_ready()},emit_ready:function(){var t=this;setTimeout(function(){t.trigger("ready")},0)},redirect_to_checkout:function(t){t.stopPropagation(),t.preventDefault();var e=encodeURIComponent(parent.location.toString()),i=Ngg_Pro_Cart_Settings.checkout_url;i+=i.indexOf("?")>0?"&referrer="+e:"?referrer="+e,parent.location=i},update_cart_summary:function(e){var i=this.$el.find(".nggpl-cart_summary");if(i.find(".nggpl-cart_count").text(Ngg_Pro_Cart.get_instance().item_count()+" items"),i.find(".nggpl-cart_total").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,parseFloat(Ngg_Pro_Cart.get_instance().subtotal()))),e){var n=t("<div/>").text(ngg_cart_i18n.nggpl_cart_updated).css({"text-align":"center","font-size:":"13px",color:"green","padding-top":".5em"});n.hide(),i.append(n),n.fadeIn().delay(1e3).fadeOut(500)}},update_accordion_icons:function(e,i){if("accordioncreate"==e.type){var n=0;t(e.target).find("h3").each(function(){var e=t(this).find(".ui-accordion-header-icon");e.addClass("fa"),0==n?e.addClass("fa-minus-square"):e.addClass("fa-plus-square"),n++}),t(e.target).find(".ui-accordion-header").click(function(t){"A"==t.target.nodeName&&(t.preventDefault(),window.open(t.target.href,"_blank"))})}else{if(i.oldHeader){var a=i.oldHeader.find(".ui-accordion-header-icon");a.addClass("fa").removeClass("fa-minus-square").addClass("fa-plus-square")}if(i.newHeader){var a=i.newHeader.find(".ui-accordion-header-icon");a.addClass("fa").removeClass("fa-plus-square").addClass("fa-minus-square")}}},render:function(){var e=t(this.container).find("#"+this.id);if(0==e.length||parseInt(e.attr("data-image-id"))!=this.image_id){this.$el.empty(),this.$el.attr("data-image-id",this.image_id),this.$el.append(ngg_add_to_cart_templates.add_to_cart);var i=this;this.update_cart_summary(!1);var n={};this.$el.find(".nggpl-pricelist_source_accordion").accordion({heightStyle:"content",beforeActivate:this.update_accordion_icons,create:this.update_accordion_icons}).find(".nggpl-source_contents").each(function(){var e=new Ngg_Pro_Cart.Views.Add_To_Cart.Items_Table({image_id:i.image_id});t(this).empty().append(e.render()),n[t(this).attr("id")]=e});var a={image_id:this.image_id,action:"get_image_items",cart:Ngg_Pro_Cart.instance.to_json()};t.post(parent.photocrati_ajax.url,a,function(e){"object"!=typeof e&&(e=JSON.parse(e)),_.each(e,function(t){n[t.source].items.add(t)},i);var a=0,r=function(t){i.$el.find(".nggpl-pricelist_source_accordion h3:visible:first").click()};_.each(n,function(e){if(a++,e.items.length>0)a==_.size(n)?e.$el.fadeIn(400,r):e.$el.fadeIn(400);else{var i=e.$el.parent().attr("id");a==_.size(n)?t('h3[aria-controls="'+i+'"]').hide(400,r):t('h3[aria-controls="'+i+'"]').hide(400)}}),e.length>0?(i.$el.find("#nggpl-not_for_sale").hide(),i.$el.find("#nggpl-items_for_sale").fadeIn().css("display","inline-block")):i.$el.find("#nggpl-items_for_sale").fadeOut("fast",function(){i.$el.find("#nggpl-not_for_sale").show()}),t.nplModal("get_setting","sidebar_button_color")&&i.$el.find("#ngg_checkout_btn, #ngg_update_cart_btn").css({color:t.nplModal("get_setting","sidebar_button_color")}),t.nplModal("get_setting","sidebar_button_background")&&i.$el.find("#ngg_checkout_btn, #ngg_update_cart_btn").css({"background-color":t.nplModal("get_setting","sidebar_button_background")})}),this.trigger("rendered"),t(this.container).append(this.el)}}}),Ngg_Pro_Cart.Views.Add_To_Cart.Items_Table=Backbone.View.extend({tagName:"table",class:"items_table",initialize:function(t){this.image_id=t.image_id,this.items=new Ngg_Pro_Cart.Models.PricelistItemCollection,this.items.on("add",this.render_row,this)},render:function(){return this.$el.hide(),this.$el.html(ngg_add_to_cart_templates.add_to_cart_items),this.$el.attr("data-image-id",this.image_id),this.el},render_row:function(t){var e=new Ngg_Pro_Cart.Views.Add_To_Cart.Item_Row({model:t,image_id:this.image_id});this.$el.find("tbody").append(e.render())}}),Ngg_Pro_Cart.Views.Add_To_Cart.Item_Row=Backbone.View.extend({tagName:"tr",events:{"updated_quantity input":"update_quantity"},initialize:function(t){this.image_id=t.image_id,this.model.on("change:quantity",this.update_subtotal,this)},render:function(){return this.$el.html(ngg_add_to_cart_templates.add_to_cart_item),this.$el.attr("data-item-id",this.model.id),this.$el.find(".nggpl-quantity_field input").val(this.model.get("quantity")),this.$el.find(".nggpl-description_field").text(this.model.get("title")),this.$el.find(".nggpl-price_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.get("price"))),this.$el.find(".nggpl-total_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.subtotal())),this.el},update_quantity:function(e){var i=t(e.target).val();i=isNaN(i)?0:parseInt(i),this.model.set("quantity",i),Ngg_Pro_Cart.get_instance().update_quantity(this.image_id,this.model)},update_subtotal:function(){this.$el.find(".nggpl-total_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.subtotal()))}}),"undefined"!=typeof window.Ngg_Pro_Cart&&window.Ngg_Pro_Cart.get_instance().on("refreshed_from_server ready",function(e,i){t("i.nextgen-menu-cart-icon").each(function(e){var i=window.Ngg_Pro_Cart.get_instance().subtotal(),n=t(this),a=!1,r=n.parents("li"),o=r.find(".nextgen-menu-cart-placeholder");if((n.hasClass("nextgen-menu-cart-icon-icon_and_total_with_items")||n.hasClass("nextgen-menu-cart-icon-icon_with_items"))&&i>0?a=!0:(n.hasClass("nextgen-menu-cart-icon-icon_and_total")||n.hasClass("nextgen-menu-cart-icon-icon"))&&(a=!0),o.size()>0){var i=window.Ngg_Pro_Cart.get_instance().subtotal();o.html(" ("+sprintf(Ngg_Pro_Cart_Settings.currency_format,i)+")")}a?(n.show(),r.show()):r.hide()})})}(jQuery);